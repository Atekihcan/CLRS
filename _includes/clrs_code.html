{%- assign code = include.code | default: code -%}
<div class="latex-pseudo-code" data-code="{{ code | escape }}">
    <button class="copy-code-btn" aria-label="Copy code to clipboard" title="Copy code">
        <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
        <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
    </button>
{%- assign title = include.title | default: "" -%}
{%- if title != "" -%}
    {%- assign latex = '$$' -%}
    {%- assign has_parameters = 0 -%}
    {%- if title contains '(' -%}
        {%- assign has_parameters = 1 -%}
    {%- endif -%}
    {%- assign function_parts = title | split : '(' -%}
    {%- for part in function_parts -%}
        {%- if forloop.index == 1 -%}
            {%- if has_parameters == 0 -%}
                {%- assign latex = latex | append : '\textsc {' | append: part | append : ' }' -%}
            {%- else -%}
                {%- assign latex = latex | append : '\textsc {' | append: part | append : ' }(' -%}
            {%- endif -%}
        {%- else -%}
            {%- assign latex = latex | append: part -%}
        {%- endif -%}
    {%- endfor -%}
    {%- assign latex = latex | append : '$$' -%}
    {{ latex }}
{%- endif -%}
$$\begin{aligned}
{%- assign num_tabs = 1 -%}
{%- assign booleans = "and,or" | split : ',' -%}
{%- assign constants = "TRUE,FALSE,NIL" | split : ',' -%}
{%- assign keywords = "swap,exchange,with,let,be,a,an,new,array,arrays,matrix,matrices,partition,sort,using,as,keys,is,empty,total,number,of,size,across,all,each,same,than,fewer,contained,length,first,from,minimum,same,list,lists,min-heap,max-heap" | split : ',' -%}
{%- assign conditionals = "if,elseif,else,for,while,to,downto,contiune,break,return,error,and,or,not" | split : ',' -%}
{%- assign symbols = "0,1,2,3,4,5,6,7,8,9,+,-,*,/,%,^,(,),[,],{,}" | split: ',' -%}
{%- assign delimiters = "floor,ceil" | split : ',' -%}
{%- assign lines = code | newline_to_br | strip_newlines | split : "<br />" -%}
{%- for line in lines -%}
    {%- if forloop.index0 == 0 -%}
        {%- continue -%}
    {%- endif -%}
    {%- assign delim_s= '' -%}
    {%- assign delim_e= '' -%}
    {%- assign brace_count = 0 -%}
    {%- comment -%}
    Prepare latex for tabs
    {%- endcomment -%}
    {%- assign tabs = '\quad ' -%}
    {%- assign len = line | size -%}
    {%- assign indentation = 0 -%}
    {%- for i in (1..len) -%}
        {%- assign char = line | slice: forloop.index,
        1 -%}
        {%- if char == ' ' -%}
            {%- assign indentation = indentation | plus : 1 -%}
        {%- else -%}
            {%- break -%}
        {%- endif -%}
    {%- endfor -%}
    {%- assign indentation = indentation | plus : 1 | divided_by : 4 -%}
    {%- for i in (1..indentation) -%}
        {%-assign tabs = tabs | append: '\qquad ' -%}
    {%- endfor -%}

    {%- comment -%}
    Replace latex special operators
    {%- endcomment -%}
    {%- assign latex_line = line -%}
    {%- assign latex_line = latex_line | replace : '*', '\cdot \,' -%}
    {%- assign latex_line = latex_line | replace : '%', '\mod' -%}
    {%- assign latex_line = latex_line | replace : '<=', '\leq \,' -%}
    {%- assign latex_line = latex_line | replace : '>=', '\geq \,' -%}
    {%- assign latex_line = latex_line | replace : '!=', '\not =' -%}
    {%- assign latex_line = latex_line | replace : 'infinity', '\infty' -%}
    {%- assign latex_line = latex_line | replace : 'INFINITY', '\infty' -%}
    {%- assign latex_line = latex_line | replace : 'X', '\times \,' -%}
    {%- assign latex_line = latex_line | replace : ',', ', \,' -%}
    {%- assign latex_line = latex_line | replace : '...', '\dots' -%}

    {%- comment -%}
    Pre-process quoted strings to preserve spaces and ensure proper rendering
    {%- endcomment -%}
    {%- assign quote_parts = latex_line | split: '"' -%}
    {%- assign processed_line = "" -%}
    {%- assign quotes = "" -%}
    {%- for part in quote_parts -%}
        {%- assign is_even = forloop.index0 | modulo: 2 -%}
        {%- if is_even == 0 -%}
            {%- comment -%}Outside quotes{%- endcomment -%}
            {%- assign processed_line = processed_line | append: part -%}
        {%- else -%}
            {%- comment -%}Inside quotes - store and replace with placeholder{%- endcomment -%}
            {%- assign quote_index = forloop.index0 | divided_by: 2 -%}
            {%- if quotes == "" -%}
                {%- assign quotes = part -%}
            {%- else -%}
                {%- assign quotes = quotes | append: '|||' | append: part -%}
            {%- endif -%}
            {%- assign processed_line = processed_line | append: '__QUOTE' | append: quote_index | append: '__' -%}
        {%- endif -%}
    {%- endfor -%}
    {%- assign quote_array = quotes | split: '|||' -%}

    {%- comment -%}
    Tokenize and parse
    {%- endcomment -%}
    {%- assign latex = "" -%}
    {%- assign tokens = processed_line | split : " " -%}
    {%- assign is_comment = 0 -%}
    {%- for token in tokens -%}
        {%- comment -%}
        Check if this token starts a comment (can be anywhere in the line)
        {%- endcomment -%}
        {%- if token == '//' -%}
            {%- assign is_comment = 1 -%}
        {%- endif -%}
        {%- if is_comment == 1 -%}
            {%- if token == '//' -%}
                {%- if forloop.index == 1 -%}
                    {%- assign latex = latex | append : '\textbf {' | append: token | append : ' } ' -%}
                {%- else -%}
                    {%- assign latex = latex | append : '\quad \textbf {' | append: token | append : ' } ' -%}
                {%- endif -%}
            {%- else -%}
                {%- assign is_word = 1 -%}
                {%- assign non_hyphen_symbols = "0,1,2,3,4,5,6,7,8,9,+,*,/,%,^,(,),[,],{,}" | split: ',' -%}
                {%- for sym in non_hyphen_symbols -%}
                    {%- if token contains sym -%}
                        {%- assign is_word = 0 -%}
                    {%- endif -%}
                {%- endfor -%}
                {%- if is_word == 0 -%}
                    {%- assign latex = latex | append: token -%}
                {%- else -%}
                    {%- assign latex = latex | append : '\text { ' | append: token | append : '}\,' -%}
                {%- endif -%}
            {%- endif -%}
            {%- continue -%}
        {%- endif -%}
        {%- comment -%}
        Otherwise parse like code
        {%- endcomment -%}
        {%- if booleans contains token or constants contains token or keywords contains token -%}
            {%- comment -%}
            Handle keywords
            {%- endcomment -%}
            {%- if forloop.index == 1 -%}
                {%- assign latex = latex | append : '\text {' | append: token | append : '}' -%}
            {%- else -%}
                {%- assign latex = latex | append : '\,\text {' | append: token | append : '}' -%}
            {%- endif -%}
            {%- elsif conditionals contains token -%}
            {%- if forloop.index == 1 -%}
                {%- assign latex = latex | append : '\textbf {' | append: token | append : ' }' -%}
            {%- else -%}
                {%- assign latex = latex | append : '\textbf { ' | append: token | append : ' }' -%}
            {%- endif -%}
        {%- elsif token contains '__QUOTE' -%}
            {%- comment -%}
            Handle quoted string placeholders
            {%- endcomment -%}
            {%- assign quote_idx_str = token | replace: '__QUOTE', '' | replace: '__', '' -%}
            {%- assign quote_idx = quote_idx_str | plus: 0 -%}
            {%- assign quote_text = quote_array[quote_idx] -%}
            {%- assign latex = latex | append : '\text {\textquotedblleft ' | append: quote_text | append : '\textquotedblright} ' -%}
        {%- else -%}
            {%- if token contains '(' -%}
                {%- comment -%}
                Handle function names if there are parentheses
                {%- endcomment -%}
                {%-if delim_s != '' -%}
                    {%- assign brace_count = brace_count | plus: 1 -%}
                {%- endif -%}
                {%- assign function_parts = token | split : '(' -%}
                {%- for part in function_parts -%}
                    {%- if forloop.index == 1 -%}
                        {%- if delimiters contains part -%}
                            {%- assign brace_count = 1 -%}
                            {%- if part == 'floor' -%}
                                {%- assign delim_s= '\lfloor ' -%}
                                {%- assign delim_e= '\rfloor ' -%}
                            {%- elsif part == 'ceil' -%}
                                {%- assign delim_s= '\lceil ' -%}
                                {%- assign delim_e= '\rceil ' -%}
                            {%- endif -%}
                            {%- assign latex = latex | append : delim_s -%}
                        {%- else -%}
                            {%- assign latex = latex | append : '\textsc {' | append: part | append : '}(' -%}
                        {%- endif -%}
                    {%- else -%}
                        {%- if part contains '_' -%}
                            {%- comment -%}
                            Handle subscript
                            {%- endcomment -%}
                            {%- assign token_parts = part | split : '_' -%}
                            {%- assign latex = latex | append: token_parts[0] | append: '_{' | append: token_parts[1] | append: '}' -%}
                        {%- else -%}
                            {%- assign latex = latex | append: part -%}
                        {%- endif -%}
                    {%- endif -%}
                {%- endfor -%}
            {%- elsif token contains ')' and delim_s != '' -%}
                {%- comment -%}
                Handle function ending
                {%- endcomment -%}
                {%- if brace_count > 1 -%}
                    {%- assign latex = latex | append: token -%}
                    {%- assign brace_count = brace_count | minus: 1 -%}
                {%- else -%}
                    {%- assign latex = latex | append: delim_e -%}
                    {%- assign brace_count = 0 -%}
                    {%- assign delim_s= '' -%}
                    {%- assign delim_e= '' -%}
                {%- endif -%}
            {%- elsif token contains '_' -%}
                {%- comment -%}
                Handle subscript
                {%- endcomment -%}
                {%- assign token_parts = token | split : '_' -%}
                {%- if forloop.index == 1 -%}
                    {%- assign latex = latex | append: token_parts[0] | append: '_{' | append: token_parts[1] | append: '}' -%}
                {%- else -%}
                    {%- assign latex = latex | append: '\,' | append: token_parts[0] | append: '_{' | append: token_parts[1] | append: '}' -%}
                {%- endif -%}
            {%- else -%}
                {%- if forloop.index == 1 -%}
                    {%- assign latex = latex | append: token -%}
                {%- else -%}
                    {%- assign latex = latex | append: '\,' | append: token -%}
                {%- endif -%}
            {%- endif -%}
        {%- endif -%}
    {%- endfor -%}
    {{ forloop.index0 | plus: include.offset }}& {{ tabs }} {{ latex }} \\
{%- endfor -%}
\end{aligned}$$</div>
