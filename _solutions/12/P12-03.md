---
title:       Problem 12-3
published:   2025-11-16 10:00
modified:    2025-11-16 10:00
keywords:    "binary search tree, average depth, randomly built tree, quicksort, recurrence"
description: "In this problem, we prove that the average depth of a node in a randomly built binary search tree with n nodes is O(lg n). Although this result is weaker than that of Theorem 12.4, the technique we shall use reveals a surprising similarity between the building of a binary search tree and the execution of RANDOMIZED-QUICKSORT from Section 7.3."
---

> **Average node depth in a randomly built binary search tree**
>
> In this problem, we prove that the average depth of a node in a randomly built binary search tree with $$n$$ nodes is $$O(\lg n)$$. Although this result is weaker than that of Theorem 12.4, the technique we shall use reveals a surprising similarity between the building of a binary search tree and the execution of $$\textsc{Randomized-Quicksort}$$ from Section 7.3.
>
> We define the **total path length** $$P(T)$$ of a binary tree $$T$$ as the sum, over all nodes $$x$$ in $$T$$, of the depth of node $$x$$, which we denote by $$d(x,T)$$.

### A. Average Depth

> Argue that the average depth of a node in $$T$$ is $$\frac{1}{n} \sum_{x \in T} d(x,T) = \frac{1}{n} P(T)$$.
>
> Thus, we wish to show that the expected value of $$P(T)$$ is $$O(n \lg n)$$.

The average depth is the sum of all node depths divided by the number of nodes:

$$\text{Average depth} = \frac{\sum_{x \in T} d(x,T)}{n} = \frac{P(T)}{n}$$

To show average depth is $$O(\lg n)$$, we need $$P(T) = O(n \lg n)$$, which gives average depth $$= \frac{O(n \lg n)}{n} = O(\lg n)$$ ✓

### B. Recursive Formula for Path Length

> Let $$T_L$$ and $$T_R$$ denote the left and right subtrees of tree $$T$$, respectively. Argue that if $$T$$ has $$n$$ nodes, then $$P(T) = P(T_L) + P(T_R) + n - 1$$.

Every node in $$T$$ except the root is either in $$T_L$$ or $$T_R$$.

For any node $$x$$ in $$T_L$$:
$$d(x, T) = d(x, T_L) + 1$$

(The depth in $$T$$ is one more than the depth in $$T_L$$ because we must pass through the root)

Similarly, for any node $$x$$ in $$T_R$$:
$$d(x, T) = d(x, T_R) + 1$$

The root has depth 0 in $$T$$.

Therefore:
$$\begin{align*}
P(T) &= \sum_{x \in T} d(x, T) \\
&= 0 + \sum_{x \in T_L} d(x, T) + \sum_{x \in T_R} d(x, T) \\
&= \sum_{x \in T_L} (d(x, T_L) + 1) + \sum_{x \in T_R} (d(x, T_R) + 1) \\
&= \sum_{x \in T_L} d(x, T_L) + |T_L| + \sum_{x \in T_R} d(x, T_R) + |T_R| \\
&= P(T_L) + P(T_R) + (|T_L| + |T_R|) \\
&= P(T_L) + P(T_R) + (n - 1)
\end{align*}$$

since $$|T_L| + |T_R| = n - 1$$ (all nodes except the root) ✓

### C. Average Total Path Length

> Let $$P(n)$$ denote the average total path length of a randomly built binary search tree with $$n$$ nodes. Show that
>
> $$P(n) = \frac{1}{n} \sum_{i=0}^{n-1} (P(i) + P(n-i-1) + n - 1)$$

In a randomly built BST on $$n$$ nodes, each of the $$n$$ nodes is equally likely to be the root (probability $$1/n$$ for each).

If node with rank $$i+1$$ (the $$(i+1)$$-th smallest) is the root:
- Left subtree $$T_L$$ has $$i$$ nodes (randomly built BST on those $$i$$ nodes)
- Right subtree $$T_R$$ has $$n-i-1$$ nodes (randomly built BST on those nodes)

By part B: $$P(T) = P(T_L) + P(T_R) + n - 1$$

Taking expectations:
$$\mathbb{E}[P(T) \mid \text{rank of root} = i+1] = P(i) + P(n-i-1) + n - 1$$

Averaging over all possible roots:
$$\begin{align*}
P(n) &= \mathbb{E}[P(T)] \\
&= \sum_{i=0}^{n-1} \Pr[\text{root has rank } i+1] \cdot \mathbb{E}[P(T) \mid \text{root has rank } i+1] \\
&= \sum_{i=0}^{n-1} \frac{1}{n} (P(i) + P(n-i-1) + n - 1) \\
&= \frac{1}{n} \sum_{i=0}^{n-1} (P(i) + P(n-i-1) + n - 1)
\end{align*}$$

✓

{% include ads.html %}

### D. Rewrite Recurrence

> Show how to rewrite $$P(n)$$ as
>
> $$P(n) = \frac{2}{n} \sum_{k=1}^{n-1} P(k) + \Theta(n)$$

From part C:
$$P(n) = \frac{1}{n} \sum_{i=0}^{n-1} (P(i) + P(n-i-1) + n - 1)$$

Split the sum:
$$P(n) = \frac{1}{n} \sum_{i=0}^{n-1} P(i) + \frac{1}{n} \sum_{i=0}^{n-1} P(n-i-1) + \frac{1}{n} \sum_{i=0}^{n-1} (n-1)$$

The last term: $$\frac{1}{n} \sum_{i=0}^{n-1} (n-1) = \frac{1}{n} \cdot n(n-1) = n-1 = \Theta(n)$$

For the second sum, substitute $$k = n-i-1$$:
- When $$i = 0$$: $$k = n-1$$
- When $$i = n-1$$: $$k = 0$$

So: $$\sum_{i=0}^{n-1} P(n-i-1) = \sum_{k=0}^{n-1} P(k)$$

Therefore:
$$P(n) = \frac{1}{n} \sum_{i=0}^{n-1} P(i) + \frac{1}{n} \sum_{k=0}^{n-1} P(k) + \Theta(n)$$

$$P(n) = \frac{2}{n} \sum_{k=0}^{n-1} P(k) + \Theta(n)$$

Since $$P(0) = 0$$ (empty tree has no nodes), we can write:

$$P(n) = \frac{2}{n} \sum_{k=1}^{n-1} P(k) + \Theta(n)$$

✓

### E. Conclude $$P(n) = O(n \lg n)$$

> Recalling the alternative analysis of the randomized version of quicksort given in Problem 7-3, conclude that $$P(n) = O(n \lg n)$$.

The recurrence $$P(n) = \frac{2}{n} \sum_{k=1}^{n-1} P(k) + \Theta(n)$$ is **identical** to the recurrence for the expected running time of randomized quicksort!

In Problem 7-3, this recurrence was solved to give $$O(n \lg n)$$.

We can verify by substitution. Guess $$P(n) \le c n \lg n$$ for some constant $$c > 0$$:

$$\begin{align*}
P(n) &= \frac{2}{n} \sum_{k=1}^{n-1} P(k) + \Theta(n) \\
&\le \frac{2}{n} \sum_{k=1}^{n-1} ck \lg k + dn \\
&\le \frac{2c}{n} \sum_{k=1}^{n-1} k \lg n + dn \quad \text{(since } k \le n \text{)} \\
&= \frac{2c \lg n}{n} \cdot \frac{(n-1)n}{2} + dn \\
&= c(n-1) \lg n + dn \\
&\le cn \lg n + dn - c \lg n \\
&\le cn \lg n
\end{align*}$$

for sufficiently large $$c$$ (choosing $$c > d$$).

Therefore, $$P(n) = O(n \lg n)$$, and the average depth is $$O(\lg n)$$ ✓

{% capture note %}
**Connection to Quicksort:**

This problem reveals a deep connection between BST construction and quicksort:

1. **BST:** Choose random root (rank), recursively build left/right subtrees
2. **Quicksort:** Choose random pivot (rank), recursively sort left/right subarrays

Both have the same recursive structure, leading to the same recurrence and the same $$O(n \lg n)$$ expected time/depth.

This is not a coincidence! Both algorithms partition elements based on a random element's rank, leading to balanced recursive subproblems in expectation.
{% endcapture %}
{% include aside.html title='BST construction and quicksort are cousins' %}
